// assets/js/main.js

// Function to create a cookie
function createCookie(name, value, days) {
    var expires = "";
    if (days) {
      var date = new Date();
      date.setTime(date.getTime() + 24 * days * 60 * 60 * 1000);
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + value + expires + "; path=/";
  }
  
  // Function to read a cookie
  function readCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(";");
    for (var i = 0; i < ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) === " ") c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0)
        return c.substring(nameEQ.length, c.length);
    }
    return null;
  }
  
  // Function to add cookie consent listener
  function addCookieConsentListener() {
    var acceptButton = document.getElementById("cookie-notice-accept");
    var cookieNotice = document.getElementById("cookie-notice");
  
    if (acceptButton && cookieNotice) {
      acceptButton.addEventListener("click", function () {
        createCookie(cookieName, "true", 31);
        cookieNotice.style.display = "none";
        location.reload();
      });
    }
  }
  
  // Function to initialize Google Analytics
  function googleAnalytics() {
    function gtag() {
      dataLayer.push(arguments);
    }
  
    if (analyticsName && analyticsName.toLowerCase() !== "") {
      window.dataLayer = window.dataLayer || [];
      gtag("js", new Date());
      gtag("config", analyticsName);
  
      window.ga =
        window.ga ||
        function () {
          (ga.q = ga.q || []).push(arguments);
        };
      ga.l = +new Date();
      ga("create", analyticsName, "auto");
      ga("send", "pageview");
    }
  }
  
  // Theme-related functions and variables
  // Icons: fa-sun (light), fa-moon (dark), fa-circle-half-stroke (system/auto - half-shaded circle)
  const themeButton = {
    system: '<i class="fa-solid fa-circle-half-stroke" aria-hidden="true"></i>',
    light: '<i class="fa-solid fa-sun" aria-hidden="true"></i>',
    dark: '<i class="fa-solid fa-moon" aria-hidden="true"></i>',
  };
  
  // Theme cycle order: system -> light -> dark -> system
  const themeCycle = ["system", "light", "dark"];
  
  function currentTheme() {
    return sessionStorage.getItem("theme");
  }
  
  function getNextTheme(current) {
    var currentIndex = themeCycle.indexOf(current);
    if (currentIndex === -1) {
      // If current theme is not in cycle (shouldn't happen), default to system
      return "system";
    }
    // Cycle to next theme
    var nextIndex = (currentIndex + 1) % themeCycle.length;
    return themeCycle[nextIndex];
  }
  
  function getThemeLabel(mode) {
    switch(mode) {
      case "system": return strSystem || "System";
      case "light": return strLight || "Light";
      case "dark": return strDark || "Dark";
      default: return mode;
    }
  }
  
  function updateTooltip(mode) {
    var themeToggle = document.getElementById("theme-toggle");
    if (themeToggle) {
      var nextMode = getNextTheme(mode);
      var nextLabel = getThemeLabel(nextMode);
      var switchToText = strSwitchTo || "Switch to";
      themeToggle.setAttribute("title", switchToText + " " + nextLabel);
      themeToggle.setAttribute("aria-label", switchToText + " " + nextLabel);
    }
  }
  
  function setMode(mode, saveToStorage) {
    var actualMode = mode;
    
    // If mode is "system", determine actual theme from system preference
    if (mode === "system") {
      var prefersDark = window.matchMedia("(prefers-color-scheme: dark)");
      actualMode = prefersDark.matches ? "dark" : "light";
    }
    
    document.documentElement.setAttribute("data-theme", actualMode);
    document.documentElement.setAttribute("data-theme-preference", mode); // Store user preference
    
    // Only save to sessionStorage if explicitly requested (user manual toggle)
    if (saveToStorage) {
      sessionStorage.setItem("theme", mode);
    }
    
    var themeToggle = document.getElementById("theme-toggle");
    if (themeToggle) {
      themeToggle.innerHTML = themeButton[mode] || themeButton.system;
      updateTooltip(mode);
    }
  }
  
  function themeToggle() {
    // Get current preference (system, light, or dark), not the actual applied theme
    var currentPreference = document.documentElement.getAttribute("data-theme-preference") || 
                           currentTheme() || 
                           "system";
    
    // Cycle to next theme
    var nextMode = getNextTheme(currentPreference);
    
    // Save to storage when user manually toggles (this marks it as user preference)
    setMode(nextMode, true);
  }
  
  // Initialize theme on window load
  window.onload = function () {
    if (isAutoTheme) {
      // Listen for system theme changes (only if user preference is "system")
      var prefersDark = window.matchMedia("(prefers-color-scheme: dark)");
      
      function handleSystemThemeChange(e) {
        // Only update if user preference is "system"
        var userPreference = document.documentElement.getAttribute("data-theme-preference") || 
                            currentTheme() || 
                            "system";
        if (userPreference === "system") {
          var systemTheme = e.matches ? "dark" : "light";
          // Update actual theme but keep preference as "system"
          document.documentElement.setAttribute("data-theme", systemTheme);
        }
      }
      
      // Listen for system theme changes
      prefersDark.addEventListener("change", handleSystemThemeChange);
      
      // Set initial theme: use saved preference, or fall back to system
      var savedTheme = currentTheme();
      var initialPreference = savedTheme || "system";
      
      // If head.liquid already set the preference, use that instead
      var domPreference = document.documentElement.getAttribute("data-theme-preference");
      if (domPreference) {
        initialPreference = domPreference;
      }
      
      // Apply the theme (this will also update icon and tooltip)
      setMode(initialPreference, false);
    }
  };
  
  // Initialize Masonry layout
  try {
    var elem = document.querySelector(".grid");
    var msnry = new Masonry(elem, {
      itemSelector: ".grid-item",
      columnWidth: ".grid-sizer",
      gutter: ".gutter-sizer",
      percentPosition: true,
    });
    var imgLoad = imagesLoaded(elem);
    imgLoad.on("progress", function (instance, image) {
      msnry.layout();
    });
  } catch (e) {
    if (!(e instanceof ReferenceError)) throw e;
  }
  
  // Toggle navigation menu on mobile
  document.addEventListener("DOMContentLoaded", function () {
    var pull = document.getElementById("pull");
    var nav = document.querySelector("nav ul");
  
    if (pull && nav) {
      // Icons and tooltips are handled entirely by CSS - just toggle menu visibility
      ["click", "touch"].forEach(function (event) {
        pull.addEventListener(event, function () {
          nav.classList.toggle("hide");
        }, false);
      });
    }
  
    // Initialize Parallax Background Effect
    initParallaxBackground();
  });
  
  // Function to initialize parallax background effect
  function initParallaxBackground() {
    const parallaxElement = document.getElementById("main");
    if (!parallaxElement) return;
  
    let ticking = false;
  
    window.addEventListener("scroll", function () {
      if (!ticking) {
        window.requestAnimationFrame(function () {
          let scrollY = window.scrollY || window.pageYOffset || document.body.scrollTop;
          let backgroundY = scrollY * 0.5; // Parallax factor
          parallaxElement.style.backgroundPosition = `center ${backgroundY}px`;
          ticking = false;
        });
        ticking = true;
      }
    });
  }
  
  // Initialize Cookie Consent and Google Analytics based on cookie
  if (isCookieConsent.toLowerCase() === "true") {
    addCookieConsentListener();
    if (readCookie(cookieName) === "true") {
      googleAnalytics();
    } else {
      var cookieNotice = document.getElementById("cookie-notice");
      if (cookieNotice) {
        cookieNotice.style.display = "block";
      }
    }
  } else {
    googleAnalytics();
  }